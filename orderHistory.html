<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="cart.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
    <title>Order History</title>
    <style>
        /* Popup style */
        .order-popup {
          position: fixed;
          top: 20px;
          left: 20px;
          background: #333;
          color: #fff;
          padding: 15px 20px;
          border-radius: 8px;
          font-weight: 500;
          opacity: 0;
          transform: translateY(-20px);
          transition: all 0.5s ease;
          z-index: 9999;
        }

        .order-popup.show {
          opacity: 1;
          transform: translateY(0);
        }

        .print-btn {
          background-color: #007bff;
          color: #fff;
          border: none;
          border-radius: 5px;
          padding: 5px 10px;
          cursor: pointer;
        }

        .print-btn:hover {
          background-color: #0056b3;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printSection, #printSection * {
                visibility: visible;
            }
            #printSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div>
            <ul id="navbar">
                <div class="logo">
                    <img src="images/smallNikelogo_23.jpg" alt="">
                </div>
                <li id="profileMenu" style="display: none;"><a href="account.html" title="My Account"><i class="uil uil-user-circle"></i></a></li>
                <li><a href="ecommerce.html">Home</a></li>
                <li><a href="shop.html">Shop</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html" class="contact_link">Contact</a></li>
                <li id="lg-bag"><a href="cart.html" class="nav_link cart_link"><i class="uil uil-shopping-cart"></i></a></li>
                <li id="loginMenu"><a class="button" id="form-open">Login</a></li>
                <a href="#" id="close"><i class="uil uil-times"></i></a>
            </ul>
        </div>
        <div id="mobile">
            <a href="cart.html" class="nav_link cart_link"><i class="uil uil-shopping-cart"></i></a>
            <i id="bar" class="uil uil-bars"></i>
        </div>
    </header>

    <!-- Breadcrumbs -->
    <nav class="breadcrumbs">
        <a href="ecommerce.html">Home</a> &gt;
        <a href="account.html">Profile</a> &gt;
        <a href="orderHistory.html" class="active">Order History</a>
    </nav>

    <section class="section-p1" id="order-history">
        <h2>Order History</h2>
        <table width="100%" id="orderTable">
            <thead>
                <tr>
                    <td>Image</td>
                    <td>Product</td>
                    <td>Size</td>
                    <td>Price</td>
                    <td>Quantity</td>
                    <td>Total</td>
                    <td>Status</td>
                    <td>Print</td>
                </tr>
            </thead>
            <tbody id="orderTableBody"></tbody>
        </table>
        <p id="noOrders" style="display:none; text-align:center;">No orders found.</p>
        <p id="loginPrompt" style="display:none; text-align:center;">Please log in to view your order history.</p>
    </section>

    <!-- Print container -->
    <div id="printSection" style="display:none;"></div>

<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
import { app } from "./firebase.js";

const auth = getAuth(app);
const db = getFirestore(app);
const orderTableBody = document.getElementById('orderTableBody');
const noOrders = document.getElementById('noOrders');
const loginPrompt = document.getElementById('loginPrompt');
const profileMenu = document.getElementById('profileMenu');
const loginMenu = document.getElementById('loginMenu');
const printSection = document.getElementById('printSection');

function updateNavbar(user) {
    if (user) {
        profileMenu.style.display = 'list-item';
        loginMenu.style.display = 'none';
    } else {
        profileMenu.style.display = 'none';
        loginMenu.style.display = 'list-item';
    }
}

function printOrder(item, discountCode) {
    const priceNum = Number(item.price?.toString().replace(/[^0-9.]/g, '')) || 0;
    const quantity = Number(item.quantity) || 0;
    let total = priceNum * quantity;

    // Apply discount
    if (discountCode === "DISC10") total *= 0.9;
    if (discountCode === "DISC20") total *= 0.8;

    const content = `
        <div style="text-align:center; font-family: Arial;">
            <h2>Order Details</h2>
            <img src="${item.image}" alt="${item.name}" width="120" style="margin-bottom:10px; border-radius:8px;">
            <p><strong>Product:</strong> ${item.name}</p>
            <p><strong>Size:</strong> ${item.size}</p>
            <p><strong>Price:</strong> ₱${priceNum.toLocaleString()}</p>
            <p><strong>Quantity:</strong> ${quantity}</p>
            ${discountCode !== "NONE" ? `<p><strong>Discount:</strong> ${discountCode}</p>` : ""}
            <p><strong>Total:</strong> ₱${total.toLocaleString()}</p>
        </div>
    `;
    printSection.innerHTML = content;
    printSection.style.display = 'block';
    window.print();
    printSection.style.display = 'none';
}

function loadOrderHistory(user) {
    if (!user) {
        orderTableBody.innerHTML = '';
        noOrders.style.display = 'none';
        loginPrompt.style.display = 'block';
        updateNavbar(null);
        return;
    }

    const q = query(collection(db, "orders"), where("userId", "==", user.uid));

    onSnapshot(q, (querySnapshot) => {
        orderTableBody.innerHTML = '';
        let hasOrders = false;

        querySnapshot.forEach((docSnap) => {
            const order = docSnap.data();
            const discountCode = order.discountCode || "NONE";

            order.cart.forEach(item => {
                hasOrders = true;
                const priceNum = Number(item.price?.toString().replace(/[^0-9.]/g, '')) || 0;
                const totalBefore = priceNum * item.quantity;

                // apply discount
                let total = totalBefore;
                if (discountCode === "DISC10") total *= 0.9;
                if (discountCode === "DISC20") total *= 0.8;

                const statusClass = (order.status || "pending").toLowerCase();

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${item.image}" alt="${item.name}" width="60"></td>
                    <td>${item.name}</td>
                    <td>${item.size}</td>
                    <td>₱${priceNum.toLocaleString()}</td>
                    <td>${item.quantity}</td>
                    <td>
                        ₱${total.toLocaleString()}
                        ${discountCode !== "NONE" ? `<br><small style="color:green;">(${discountCode})</small>` : ""}
                    </td>
                    <td><span class="status ${statusClass}">${order.status || 'pending'}</span></td>
                    <td><button class="print-btn">Print</button></td>
                `;
                row.querySelector('.print-btn').addEventListener('click', () => printOrder(item, discountCode));
                orderTableBody.appendChild(row);
            });
        });

        if (!hasOrders) {
            noOrders.style.display = 'block';
            orderTableBody.style.display = 'none';
        } else {
            noOrders.style.display = 'none';
            orderTableBody.style.display = 'table-row-group';
        }
        loginPrompt.style.display = 'none';
    });

    updateNavbar(user);
}

onAuthStateChanged(auth, (user) => {
    loadOrderHistory(user);
});

document.addEventListener('DOMContentLoaded', () => {
    const user = auth.currentUser;
    if (user) {
        loadOrderHistory(user);
    }
});
</script>

</body>
</html>
